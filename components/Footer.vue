<template>
 <div class="">
  <div class="grid grid-cols-1 lg:grid-cols-3">
    <div class="bg-[#1D1D1D] p-5 px-10 flex py-16 justify-center items-center">
      <div class="bg-[#1D1D1D]">
        <h2 class="text-2xl font-semibold text-[#EBEBEB] mb-4">Level up your brand</h2>
        <p class="text-[#EBEBEB] mb-12">
          We' love to hear from you. Our friendly team is always here to chat.
        </p>


        <div class="space-y-8">

          <div class="flex items-start gap-4">
            <div class="text-[#3B82F6] mt-1">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6M22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6M22 6L12 13L2 6" stroke="#0072C6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

            </div>
            <div>
              <h3 class="font-medium text-[#E8E8E8] mb-1">Email us</h3>
              <a href="mailto:hello@gobuildr.i" class="text-[#00BFFF] text-sm hover:underline">hello@gobuildr.io</a>
            </div>
          </div>


          <div class="flex items-start gap-4">
            <div class="text-[#3B82F6] mt-1">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="#0072C6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="#0072C6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

            </div>
            <div>
              <h3 class="font-medium text-[#E8E8E8] mb-1">Office</h3>
              <p class="text-[#00BFFF] text-sm">1200 Bay St.Toronto,</p>
              <p class="text-[#00BFFF] text-sm"> ON M5H 2V1</p>
            </div>
          </div>

          <!-- Phone -->
          <div class="flex items-start gap-4">
            <div class="text-[#3B82F6] mt-1">
              <svg width="24" height="26" viewBox="0 0 24 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M22.0004 18.9201V21.9201C22.0016 22.1986 21.9445 22.4743 21.8329 22.7294C21.7214 22.9846 21.5577 23.2137 21.3525 23.402C21.1473 23.5902 20.905 23.7336 20.6412 23.8228C20.3773 23.912 20.0978 23.9452 19.8204 23.9201C16.7433 23.5857 13.7874 22.5342 11.1904 20.8501C8.77425 19.3148 6.72576 17.2663 5.19042 14.8501C3.5004 12.2413 2.44866 9.27109 2.12042 6.1801C2.09543 5.90356 2.1283 5.62486 2.21692 5.36172C2.30555 5.09859 2.44799 4.85679 2.63519 4.65172C2.82238 4.44665 3.05023 4.28281 3.30421 4.17062C3.5582 4.05843 3.83276 4.00036 4.11042 4.0001H7.11042C7.59573 3.99532 8.06621 4.16718 8.43418 4.48363C8.80215 4.80008 9.0425 5.23954 9.11042 5.7201C9.23704 6.68016 9.47187 7.62282 9.81042 8.5301C9.94497 8.88802 9.97408 9.27701 9.89433 9.65098C9.81457 10.0249 9.62928 10.3682 9.36042 10.6401L8.09042 11.9101C9.51398 14.4136 11.5869 16.4865 14.0904 17.9101L15.3604 16.6401C15.6323 16.3712 15.9756 16.1859 16.3495 16.1062C16.7235 16.0264 17.1125 16.0556 17.4704 16.1901C18.3777 16.5286 19.3204 16.7635 20.2804 16.8901C20.7662 16.9586 21.2098 17.2033 21.527 17.5776C21.8441 17.9519 22.0126 18.4297 22.0004 18.9201Z" stroke="#0072C6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

            </div>
            <div>
              <h3 class="font-medium text-[#E8E8E8] mb-1">Phone</h3>
              <a href="tel:+14162508459" class="text-[#00BFFF] text-sm">+1 (416) 250-8459</a>

            </div>
          </div>
        </div>

        <!-- Social Links -->
        <div class="flex justify-between items-center gap-4 mt-12">
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
            </svg>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" />
            </svg>
          </a>
        </div>
      </div>
    </div>
    <div class="bg-[#161616] lg:col-span-2 py-16 flex justify-center items-center">
      <form @submit.prevent="sendMessage" class="space-y-6 w-full px-8 lg:max-w-lg mx-auto">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm text-[#E8E8E8] font-medium mb-2">First name</label>
              <input
                v-model="formData.firstName"
                type="text"
                class="w-full px-4 py-4 text-sm bg-[#252526] text-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="First name"
              >
            </div>
            <div>
              <label class="block text-sm text-[#E8E8E8] font-medium mb-2">Last name</label>
              <input
                v-model="formData.lastName"
                type="text"
                class="w-full px-4 py-4 text-sm bg-[#252526] text-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="Last name"
              >
            </div>
          </div>
  
          <div>
            <label class="block text-sm text-[#E8E8E8] font-medium mb-2">Email</label>
            <input
              v-model="formData.email"
              type="email"
              class="w-full px-4 py-4 text-sm bg-[#252526] text-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="you@company.com"
            >
          </div>

          <div>
            <label class="block text-sm text-[#E8E8E8] font-medium mb-2">Phone number</label>
            <div class="flex">
              <div class="relative">
                <select
                  v-model="selectedCountry"
                  class="px-3 py-4 text-sm bg-[#252526] rounded-l-lg text-gray-300 border-r border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none appearance-none pr-8"
                  required
                >
                  <option v-for="country in countries" 
                          :key="country.code" 
                          :value="country"
                          class="py-2"
                  >
                    {{ country.flag }} {{ country.dialCode }}
                  </option>
                </select>
                <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
              <input
                v-model="phoneInput"
                type="tel"
                @input="validatePhoneNumber"
                class="flex-1 px-4 py-3 bg-[#252526] rounded-r-lg text-gray-300 focus:ring-2 focus:ring-blue-500 outline-none"
                :placeholder="selectedCountry.example"
                required
              >
            </div>
            <span v-if="phoneError" class="text-red-500 text-xs mt-1">{{ phoneError }}</span>
          </div>
  
          <div>
            <label class="block text-sm text-[#E8E8E8] font-medium mb-2">Message</label>
            <textarea
              v-model="formData.message"
              rows="4"
              class="w-full px-4 py-4 text-sm bg-[#252526] text-gray-300 resize-none rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="Enter a message..."
            ></textarea>
          </div>
  
          <div class="flex items-center">
            <input
              v-model="form.privacyPolicy"
              type="checkbox"
              class="w-4 h-4 bg-[#252526] rounded border-gray-600 text-blue-500 focus:ring-blue-500"
            >
            <label class="ml-2 text-sm text-gray-400">
              You agree to our <NuxtLink class="underline z-50" to="/privacy-policy">privacy policy.</NuxtLink>
            </label>
          </div>
  
          <button
            type="submit" 
             :disabled="!isFormValid || loading"
            class="w-full disabled:cursor-not-allowed disabled:opacity-250 bg-[#0072C6] rounded-full text-white py-3.5 px-6 transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
          {{ loading ? 'processing' : 'Send message' }}
          </button>
        </form>
    </div>
  </div>
  <div class="max-w-7xl mx-auto flex justify-between py-6 items-center px-5 lg:px-0">
        <NuxtLink to="/privacy-policy" class="text-[#222222] font-bold">Privacy Policy</NuxtLink>
        <p class="text-[#222222] font-bold">© 2023 Buildr</p>
      </div>

      <CoreBaseModal :show="showModal" @update:show="showModal = $event">
            <section class="max-w-2xl px-3 py-6 mx-auto">
                <main class="mt-8 space-y-6">
                    <img class="object-cover w-full h-56 rounded-lg md:h-72"
                        src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80"
                        alt="">

                    <h2 class="mt-6 text-gray-800 font-semibold text-lg">Hello {{
                    capitalizeFirstLetter(formData.firstName) }} {{
                    capitalizeFirstLetter(formData.lastName)
                        }},</h2>

                    <p class="mt-2 leading-loose text-gray-800 text-sm">
                        Thank you for contacting CodeRed! We’re thrilled to hear from you and are eager to learn more
                        about how we can accelerate your digital journey. A member of our team will be in touch within
                        the next 24 hours to discuss your needs and how we can help your business innovate and grow. We
                        look forward to working together to create something amazing.
                    </p>

                    <p class="mt-2 text-gray-800 text-sm">
                        Best regards, <br>
                        The CodeRed Team
                    </p>
                </main>
            </section>
        </CoreBaseModal>
 </div>
</template>

<script setup lang="ts">
import { useCustomToast } from '@/composables/core/useCustomToast'
import { countries, Country } from '@/types/country';

const { showToast } = useCustomToast()

const sortedCountries = computed(() => {
  return [...countries].sort((a, b) => {
    if (a.code === 'US') return -1;
    if (b.code === 'US') return 1;
    return a.name.localeCompare(b.name);
  });
});

const form = ref({
  privacyPolicy: false
});

const processing = ref(false);
const phoneError = ref('');
const phoneInput = ref('');
const selectedCountry = ref(countries.find(c => c.code === 'NG') || countries[0]);

const formData = ref({
  firstName: '',
  lastName: '',
  email: '',
  phoneNumber: '',
  message: ''
});

const loading = ref(false); // Loading state

// Format phone number as user types based on country pattern
const formatPhoneNumber = (value: string, country: Country) => {
  // Remove all non-digit characters
  const numbers = value.replace(/\D/g, '');
  
  // Format based on country
  let formatted = numbers;
  switch(country.code) {
    case 'NG':
      // Nigeria: XXX XXX XXXX
      if (numbers.length <= 10) {
        formatted = numbers.replace(/(\d{3})(\d{3})?(\d{4})?/, function(_, p1, p2, p3) {
          let output = p1;
          if (p2) output += ' ' + p2;
          if (p3) output += ' ' + p3;
          return output;
        });
      }
      break;
    case 'US':
    case 'CA':
      // North America: (XXX) XXX-XXXX
      if (numbers.length <= 10) {
        formatted = numbers.replace(/(\d{3})(\d{3})?(\d{4})?/, function(_, p1, p2, p3) {
          let output = '(' + p1 + ')';
          if (p2) output += ' ' + p2;
          if (p3) output += '-' + p3;
          return output;
        });
      }
      break;
    default:
      // Default format: XXX XXX XXXX
      if (numbers.length <= 10) {
        formatted = numbers.replace(/(\d{3})(\d{3})?(\d{4})?/, function(_, p1, p2, p3) {
          let output = p1;
          if (p2) output += ' ' + p2;
          if (p3) output += ' ' + p3;
          return output;
        });
      }
  }
  return formatted;
};

// Watch for changes in phone input to format number
watch([phoneInput, selectedCountry], ([newPhone, newCountry]) => {
  if (phoneInput.value !== formatPhoneNumber(newPhone, newCountry)) {
    phoneInput.value = formatPhoneNumber(newPhone, newCountry);
  }
});

const validatePhoneNumber = () => {
  const pattern = selectedCountry.value.pattern;
  if (!pattern.test(phoneInput.value)) {
    phoneError.value = `Please enter a valid phone number in the format: ${selectedCountry.value.example}`;
    return false;
  }
  phoneError.value = '';
  return true;
};

const isFormValid = computed(() => {
  return !!(
    formData.value.firstName &&
    formData.value.lastName &&
    formData.value.email &&
    phoneInput.value &&
    formData.value.message &&
    // form.value.privacyPolicy &&
    !phoneError.value
  );
});

const formatPhoneForSubmission = () => {
  // Remove any formatting and combine country code with phone number
  const cleanPhone = phoneInput.value.replace(/\D/g, '');
  return `${selectedCountry.value.dialCode}${cleanPhone}`;
};

async function handleSubmit() {
  if (!isFormValid.value) return;
  
  processing.value = true;
  const url = 'https://buildr-backend.onrender.com/api/auth/signup';
  
  try {
    const submissionData = {
      ...formData.value,
      phoneNumber: formatPhoneForSubmission(),
      countryCode: selectedCountry.value.code
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(submissionData)
    });

    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const result = await response.json();
    showModal.value = true;
    
    // Reset form
    formData.value = {
      firstName: '',
      lastName: '',
      email: '',
      phoneNumber: '',
      message: ''
    };
    phoneInput.value = '';
    form.value.privacyPolicy = false;
    
  } catch (error) {
    if (process.client) {
      useNuxtApp().$toast('Error submitting form');
    }
  } finally {
    processing.value = false;
  }
}

const capitalizeFirstLetter = (string: string) => {
    if (!string) return string;
    return string.charAt(0).toUpperCase() + string.slice(1);
}

const showModal = ref(false);


//Email service

  // Response message and its color
  const responseMessage = ref('');
  const responseMessageColor = ref('');


  // Send message function
const sendMessage = async () => {
  // Set loading state to true
  loading.value = true;

  const payload = {
    service_id: 'service_5gsppio',
    template_id: 'template_4oqi6yg',
    user_id: '4J9L23-9Siwi2SQ_U',
    template_params: {
      firstName: formData.value.lastName,
      lastName: formData.value.firstName,
      phoneNumber: formatPhoneForSubmission(),
      email: formData.value.email,
      message: formData.value.message,
      to_email: 'eneaba@gmail.com', 
    },
  };

  try {
    const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    if (response.ok) {
      responseMessage.value = 'Message sent successfully!';
      responseMessageColor.value = 'text-green-600';
      // Reset form after success
      formData.value.firstName = '';
      formData.value.lastName = '';
      formData.value.email = '';
      formData.value.message = '';
      showToast({
          title: "Success",
          message:  'Message sent successfully!',
          toastType: "success",
        });
        showModal.value = true;
    } else {
      showToast({
          title: "Error",
          message: 'Error sending message. Try again.',
          toastType: "error",
          duration: 3000,
        });
      responseMessage.value = 'Error sending message. Try again.';
      responseMessageColor.value = 'text-red-600';
    }
  } catch (error) {
    showToast({
          title: "Error",
          message: 'Error sending message. Try again.',
          toastType: "error",
          duration: 3000,
        });
    responseMessage.value = 'Error sending message. Try again.';
    responseMessageColor.value = 'text-red-600';
  } finally {
    // Set loading state to false
    loading.value = false;
  }
};
</script>